---
title: "08 Simulation of Stochastic Processes"
author: "Yuanwei Qiao"
date: "11/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# 5.3.3 Ornstein-Uhlenbeck Process {#sec:Q1}

In this question, we will verify the transition density solution as we build a function that simulates various paths of a sampled random walk.  Consider the mean reversion Ornstein-Uhlenbeck process
\begin{equation}  
dr(t) = \alpha(b - r(t))dt + \sigma dW(t),
\label{eq:q1_l} \end{equation}
where $\alpha > 0$ and $\sigma > 0$ are constants and $b$ is a mean value constant of the process that is not necessarily positive.  

## Question 1a Verify the transition density
For $t > 0$ and $\Delta > 0$, we can evaluate equation (\ref{eq:q1_l}) to find the transition density.  Let $V=\exp{\{\alpha t\}}(r(t)-b)$.  Then, $\dfrac{\partial V}{\partial t} = \alpha \exp{\{\alpha t\}}(r(t)-b)$, $\dfrac{\partial V}{\partial r} = \exp{\{\alpha t\}}$, and $\dfrac{\partial^2 V}{\partial r^2} = 0$.  So, by It$\hat{\text{o}}$'s formula, $dV = \alpha \exp{\{\alpha t\}}(r(t)-b) dt + \exp{\{\alpha t\}} [\alpha(b - r(t))dt + \sigma dW(t)] + 0$, which simplifies to $dV = \sigma \exp{\{\alpha t\}} dW(t)$.  If we integrate both sides from $t$ to $t+\Delta$, we have $\int_{t}^{t +\Delta} dV = \int_{t}^{t +\Delta}\sigma \exp{\{\alpha u\}} dW(u)$.  This implies $V(t+\Delta)-V(t) = \int_{t}^{t +\Delta}\sigma \exp{\{\alpha u\}} dW(u)$.  Thus, $\exp{\{\alpha t\}}(r(t+\Delta)-b) - \exp{\{\alpha t\}}(r(t)-b) = \int_{t}^{t +\Delta}\sigma \exp{\{\alpha u\}} dW(u)$.  We add $\exp{\{\alpha t\}}(r(t)-b)$ to both sides, divide by $\exp{\{\alpha t\}}$ and add $b$ to both sides.  
Observe, 
$$
\begin{aligned}
r(t+\Delta) &= b + \exp{\{-\alpha (t+\Delta)+\alpha t\}}(r(t)-b) + \int_{t}^{t+\Delta} \sigma \exp{\{-\alpha(t+\Delta)+\alpha u\}}dW(u) \\
&= b + \exp{\{-\alpha\Delta\}}(r(t)-b) + \int_{t}^{t+\Delta} \sigma \exp{\{-\alpha(t+\Delta- u)\}}dW(u) \\
&= \exp{\{-\alpha\Delta\}}r(t) + b(1-\exp{\{-\alpha\Delta\}}) + \sigma \sqrt{\dfrac{1-\exp{\{-2\alpha \Delta \}}}{2\alpha}}Z \\
&= \exp{\{-\alpha\Delta\}}r(t) + b(1-\exp{\{-\alpha\Delta\}}) + \dfrac{\sigma}{\sqrt{2\alpha}} \sqrt{1-\exp{\{-2\alpha \Delta \}}}Z 
\end{aligned}
$$
where $Z \sim N(0,1)$.

# Question 1b Plot Random Walk

For time interval $[0,T]$, we use the follow code to simulate a sample path using the following parameters: $r(0) = 1$, $T=500$, and $\Delta = 1/500$.  We will plot the paths for all of the combinations of $\alpha \in \{0.1,1,5\}$, $\sigma \in \{ 0.1,0.2,0.5\}$, and $b \in \{-5,5 \}$.  We note that a change in the seed setting will result in different plots.  We display the plots for seeds 100, 200, and 300 below.

```{r hw4q1b, eval=TRUE, echo = TRUE, fig.cap = "\\label{fig:hw4q1b} Sample paths for Ornstein-Uhlenbeck process for set.seed(100)"}
random_walk_OU <- function(alpha, sigma, b, r_0 = 1, T_end = 500, delta = 1/500){
  
  # Initialize
  set.seed(100)
  r_t <- array()
  r_t[1] <- r_0
  # Z ~ N(0,1)
  Z <- rnorm(T_end-1,mean = 0, sd = 1)
  
  for (i in 2:T_end){
    # Calculate r(t)
    r_t[i] <- (exp(-1 * alpha * delta) * r_t[i-1] + b * (1 - exp(-1*alpha*delta)) 
      + (sigma / sqrt(2 * alpha)) * sqrt(1-exp(-2*alpha*delta))*Z[i-1])
  }
  return(r_t)
}

plot_random_walk_OU <- function(alpha, sigma, b){
  
  # Given parameters
  r_0 <- 1
  T_end <- 500
  delta <- 1/500
  
  # Initialize matrix and values for y axis range
  result_alpha <- matrix(,nrow=T_end,ncol=length(alpha)*length(sigma)*length(b))
  max_r <- 0
  min_r <- 0
  count <- 0
  
  for (i in 1:length(alpha)){
    for (j in 1:length(sigma)){
      for (k in 1:length(b)){
        count <- count + 1
        result_alpha[,count]<- random_walk_OU(alpha[i],sigma[j],b[k],r_0,T_end,delta)
        
        # For the y-axis plot range
        if (ceiling(max(result_alpha[,count])) > max_r){
          max_r <- ceiling(max(result_alpha[,count]))
        }
        if (floor(min(result_alpha[,count])) < min_r){
          min_r <- floor(min(result_alpha[,count]))
        }
      }
    }
  }

  # Colors black, red, and blue for the different sigma values
  color_lines <- rep(c(1,2,4),6)
  plot(result_alpha[,1],type="l",ylim=c(min_r,max_r),xlim=c(0,700),
       col=color_lines[1],main="Ornstein-Uhlenbeck process",ylab="r(t)",xlab="t")
  legend("topleft",legend=c(expression(paste(sigma," = 0.1 ")),
                            expression(paste(sigma," = 0.2 ")),
                            expression(paste(sigma," = 0.5 "))),
         col=color_lines[1:3],lty=1,cex=0.8,pt.cex=1)
  for (m in 2:count){
    lines(result_alpha[,m],type="l",col=color_lines[m]) 
  }
  text(x= T_end + 10,y=c(min(result_alpha[,1]),max(result_alpha[,2]),
                         min(result_alpha[,7]),max(result_alpha[,8]),
                         min(result_alpha[,15]),max(result_alpha[,16])),
       pos=4,labels = c(expression(paste(alpha," = 0.1, b = -5")),
                        expression(paste(alpha," = 0.1, b = 5")),
                        expression(paste(alpha," = 1, b = -5")),
                        expression(paste(alpha," = 1, b = 5")),
                        expression(paste(alpha," = 5, b = -5")),
                        expression(paste(alpha," = 5, b = 5"))),cex=0.8)
  
}

# For the following combination of parameters
alpha <- c(0.1, 1, 5)
sigma <- c(0.1, 0.2, 0.5)
b <- c(-5,5)

# Call the function to plot 
plot_random_walk_OU(alpha, sigma,b)
```
Looking at Figure \ref{fig:hw4q1b}, we see that the shape of the path depends on $\alpha$ while the volatility along the path is dependent on $\sigma$.  The value of $b$ determines whether the path increases (for $b=5$) or decreases (for $b=-5$) from the initial value.  As $\alpha$ increases, the path moves more away from the starting value.  

Since we observed that the setting of the seed changes our plot's output, we have included two other seeds (200 and 300) to show how the plot may change but the overall conclusions still apply in Figures \ref {fig:hw4q1b2} and \ref {fig:hw4q1b3}.


```{r hw4q1b2, eval=TRUE, echo = FALSE, fig.cap = "\\label{fig:hw4q1b2} Sample paths for Ornstein-Uhlenbeck process for set.seed(200)", fig.height = 4, fig.pos = 'htb'} 
random_walk_OU <- function(alpha, sigma, b, r_0 = 1, T_end = 500, delta = 1/500){
  
  # Initialize
  set.seed(200)
  r_t <- array()
  r_t[1] <- r_0
  
  # Z ~ N(0,1)
  Z <- rnorm(T_end-1,mean = 0, sd = 1)
  
  for (i in 2:T_end){
    # Calculate r(t)
    r_t[i] <- (exp(-1 * alpha * delta) * r_t[i-1] + b * (1 - exp(-1*alpha*delta)) 
      + (sigma / sqrt(2 * alpha)) * sqrt(1-exp(-2*alpha*delta))*Z[i-1])
  }
  
  return(r_t)
  
}

plot_random_walk_OU <- function(alpha, sigma, b){
  
  # Given parameters
  r_0 <- 1
  T_end <- 500
  delta <- 1/500
  
  # Initialize matrix and values for y axis range
  result_alpha <- matrix(,nrow=T_end,ncol=length(alpha)*length(sigma)*length(b))
  max_r <- 0
  min_r <- 0
  count <- 0
  
  for (i in 1:length(alpha)){
    for (j in 1:length(sigma)){
      for (k in 1:length(b)){
        count <- count + 1
        result_alpha[,count]<- random_walk_OU(alpha[i],sigma[j],b[k],r_0,T_end,delta)
        
        # For the y-axis plot range
        if (ceiling(max(result_alpha[,count])) > max_r){
          max_r <- ceiling(max(result_alpha[,count]))
        }
        if (floor(min(result_alpha[,count])) < min_r){
          min_r <- floor(min(result_alpha[,count]))
        }
      }
    }
  }

  # Colors black, red, and blue for the different sigma values
  color_lines <- rep(c(1,2,4),6)
  plot(result_alpha[,1],type="l",ylim=c(min_r,max_r),xlim=c(0,700),
       col=color_lines[1],main="Ornstein-Uhlenbeck process",ylab="r(t)",xlab="t")
  legend("topleft",legend=c(expression(paste(sigma," = 0.1 ")),
                            expression(paste(sigma," = 0.2 ")),
                            expression(paste(sigma," = 0.5 "))),
         col=color_lines[1:3],lty=1,cex=0.8,pt.cex=1)
  for (m in 2:count){
    lines(result_alpha[,m],type="l",col=color_lines[m]) 
  }
  text(x= T_end + 10,y=c(min(result_alpha[,1]),max(result_alpha[,2]),
                         min(result_alpha[,7]),max(result_alpha[,8]),
                         min(result_alpha[,15]),max(result_alpha[,16])),
       pos=4,labels = c(expression(paste(alpha," = 0.1, b = -5")),
                        expression(paste(alpha," = 0.1, b = 5")),
                        expression(paste(alpha," = 1, b = -5")),
                        expression(paste(alpha," = 1, b = 5")),
                        expression(paste(alpha," = 5, b = -5")),
                        expression(paste(alpha," = 5, b = 5"))),cex=0.8)
  
}

# For the following combination of parameters
alpha <- c(0.1, 1, 5)
sigma <- c(0.1, 0.2, 0.5)
b <- c(-5,5)

# Call the function to plot 
plot_random_walk_OU(alpha, sigma,b)
```

```{r hw4q1b3, eval=TRUE, echo = FALSE, fig.cap = "\\label{fig:hw4q1b3} Sample paths for Ornstein-Uhlenbeck process for set.seed(300)",fig.height = 4, fig.pos = 'htb'}
random_walk_OU <- function(alpha, sigma, b, r_0 = 1, T_end = 500, delta = 1/500){
  
  # Initialize
  set.seed(300)
  r_t <- array()
  r_t[1] <- r_0
  
  # Z ~ N(0,1)
  Z <- rnorm(T_end-1,mean = 0, sd = 1)
  
  for (i in 2:T_end){
    # Calculate r(t)
    r_t[i] <- (exp(-1 * alpha * delta) * r_t[i-1] + b * (1 - exp(-1*alpha*delta)) 
      + (sigma / sqrt(2 * alpha)) * sqrt(1-exp(-2*alpha*delta))*Z[i-1])
  }
  
  return(r_t)
  
}

plot_random_walk_OU <- function(alpha, sigma, b){
  
  # Given parameters
  r_0 <- 1
  T_end <- 500
  delta <- 1/500
  
  # Initialize matrix and values for y axis range
  result_alpha <- matrix(,nrow=T_end,ncol=length(alpha)*length(sigma)*length(b))
  max_r <- 0
  min_r <- 0
  count <- 0
  
  for (i in 1:length(alpha)){
    for (j in 1:length(sigma)){
      for (k in 1:length(b)){
        count <- count + 1
        result_alpha[,count]<- random_walk_OU(alpha[i],sigma[j],b[k],r_0,T_end,delta)
        
        # For the y-axis plot range
        if (ceiling(max(result_alpha[,count])) > max_r){
          max_r <- ceiling(max(result_alpha[,count]))
        }
        if (floor(min(result_alpha[,count])) < min_r){
          min_r <- floor(min(result_alpha[,count]))
        }
      }
    }
  }

  # Colors black, red, and blue for the different sigma values
  color_lines <- rep(c(1,2,4),6)
  plot(result_alpha[,1],type="l",ylim=c(min_r,max_r),xlim=c(0,700),
       col=color_lines[1],main="Ornstein-Uhlenbeck process",ylab="r(t)",xlab="t")
  legend("topleft",legend=c(expression(paste(sigma," = 0.1 ")),
                            expression(paste(sigma," = 0.2 ")),
                            expression(paste(sigma," = 0.5 "))),
         col=color_lines[1:3],lty=1,cex=0.8,pt.cex=1)
  for (m in 2:count){
    lines(result_alpha[,m],type="l",col=color_lines[m]) 
  }
  text(x= T_end + 10,y=c(min(result_alpha[,1]),max(result_alpha[,2]),
                         min(result_alpha[,7]),max(result_alpha[,8]),
                         min(result_alpha[,15]),max(result_alpha[,16])),
       pos=4,labels = c(expression(paste(alpha," = 0.1, b = -5")),
                        expression(paste(alpha," = 0.1, b = 5")),
                        expression(paste(alpha," = 1, b = -5")),
                        expression(paste(alpha," = 1, b = 5")),
                        expression(paste(alpha," = 5, b = -5")),
                        expression(paste(alpha," = 5, b = 5"))),cex=0.8)
  
}

# For the following combination of parameters
alpha <- c(0.1, 1, 5)
sigma <- c(0.1, 0.2, 0.5)
b <- c(-5,5)

# Call the function to plot 
plot_random_walk_OU(alpha, sigma,b)
```

\newpage
\newpage

# Question 1c Using an Euler scheme for a SDE {#sec:Q1.3}

The closed form solution for few stochastic differential equations are known and one such example is utilized by our question to verify how well the Euler scheme works in approximating a numerical solution for the given SDE. Let us consider the following Stochastic differential equation

\begin{equation}
dr(t) = \alpha(b - r(t))dt + \sigma dW(t),
\label{eq:stoch}
\end{equation}

Here W(t) stands for the weiner process with initial condition as r(0)
We do the following steps to solve the SDE:
1)Partition the time intervalinto a grid with subintervals of equal length $\delta>0$ for a small $\delta$ 
2)Approximate $r(t+\delta)$ by a normal random variable $r(t)+\alpha(b-r(t))\delta$ and standard deviation$\sigma\delta$


From previous problem we use $r(0)=1$. For simplification purposes let us choose $\alpha=1$ $b=1$ $\sigma=1$

```{r hw4q2, eval=TRUE, echo = TRUE} 
difference <- function(n, T_end){
  
  W <- c(0,cumsum(rnorm(n,mean = 0,sd = sqrt(T_end/n))))
  index <- 1:n - 1
  euler_terms <- (exp(index*T_end/(2*n)))*(sin(W[index+1]))*(W[index+2] - W[index+1])
  euler_approx <- sum(euler_terms)
  actual_value <- 1 - (exp(T_end/2))*cos(W[n+1])
  difference <- euler_approx - actual_value
  return(difference)
}

RMSD <- function(n, T_end, N){
  diff_vector <- replicate(N, difference(n,T_end))
  return(c(mean(diff_vector),sd(diff_vector),
           sqrt(mean(diff_vector^2)),sqrt(sd(diff_vector^2))))
}
set.seed(207)
n10<- RMSD(10,1,10^4)
n100<- RMSD(100,1,10^4)
n1000<- RMSD(1000,1,10^4)
```

When we ran our code, we found the following results:
For $n=10$, we found $\sqrt{\mathbb{E}D^2}$ = `r n10[3]`, and for $n = 100$, we found $\sqrt{\mathbb{E}D^2}$ = `r n100[3]`, and for $n=1000$, we found $\sqrt{\mathbb{E}D^2}$ = `r n1000[3]`. The results match with expectations that, as n increases in evaluation of the stochastic integral approximation, the root mean square deviation or the error reduces.

# 5.3.4 Evaluating a Inhomogeneous Poisson Process {#sec:Q4}

We are given a Poisson process with intensity function $$\lambda(t) = \sqrt(t) + exp(-t)sin(2\pi t)$$

1) The distribution of N(5) is a poisson random variable with mean 7.6077 which is obtained by integrating the intensity $\lambda(t)$ from 0 to 5 using Mathematica.

2) We use the following function to simulate from this poisson process using the thinning method. This function is obtained using mathematica for computing the integral. Since the intensity function reaches its maximum at 5 we use the mean at 5 as $\lambda_{max}$. The "intfun" used below is the intensity function obtained by integrating $\lambda(t)$ from 0 to t.

```{r, eval=TRUE, echo=TRUE}
## simulation of a nonhomogeneous Poisson process
## with the thinning method
rnhpp <- function(intensity, intmax, tmax) {
  n <- rpois(1, intmax)
  tt <- runif(n, 0, tmax)
  u <- runif(n)
  accept <- u < intensity(tt) / intmax
  sort(tt[accept])
}

intfun <- function(x) 
  {(2*x^(3/2))/3 + (exp(-x)*(2*pi*exp(x)- sin(2*pi*x)-2*pi*cos(2*pi*x)))/(1+4*pi*pi)}

ff <- rnhpp(intfun, 7.6077, 5)

```


3) Now we generate from this process and compare the kernel density with the true density as follows:

```{r, eval=TRUE, echo=TRUE}
hist(unlist(replicate(1000, rnhpp(intfun, 7.6077, 5))),main="The kernel vs the true density", breaks=20, freq = FALSE, ylim = c(0,1))
curve(intfun(x)/7.6077, xlim =c(0,5), add=TRUE)

```